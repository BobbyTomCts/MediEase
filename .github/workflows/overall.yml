name: overall

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  frontend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24.7.0'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      - name: Install frontend dependencies
        run: npm ci
      - name: Build frontend
        run: npm run build --if-present
      - name: Run frontend tests with coverage
        run: npx ng test --watch=false --browsers=ChromeHeadless --code-coverage
      - name: Upload frontend dist
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist/**/*
      - name: Upload frontend coverage
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: frontend/coverage/**

  backend:
    runs-on: ubuntu-latest
    needs: [frontend]
    defaults:
      run:
        working-directory: MediBuddy Backend
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: testdb
          MYSQL_USER: ci_user
          MYSQL_PASSWORD: ci_pass
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping --silent" --health-interval=10s --health-timeout=5s --health-retries=5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'
      - name: Set up Node.js (for serving frontend during UI tests)
        uses: actions/setup-node@v4
        with:
          node-version: '24.7.0'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      - name: Install MySQL client & wait for readiness
        run: |
          sudo apt-get update && sudo apt-get install -y mysql-client
          for i in {1..20}; do
            if mysqladmin ping -h 127.0.0.1 --silent; then echo "MySQL is up"; break; fi
            echo "Waiting for MySQL... ($i)"; sleep 3;
          done
          mysqladmin ping -h 127.0.0.1 --silent || { echo "MySQL did not become ready in time"; exit 1; }
      - name: Prepare test database user (idempotent)
        run: |
          mysql -h 127.0.0.1 -uroot -proot -e "CREATE DATABASE IF NOT EXISTS testdb;"
          mysql -h 127.0.0.1 -uroot -proot -e "CREATE USER IF NOT EXISTS 'ci_user'@'%' IDENTIFIED BY 'ci_pass';"
          mysql -h 127.0.0.1 -uroot -proot -e "GRANT ALL PRIVILEGES ON testdb.* TO 'ci_user'@'%'; FLUSH PRIVILEGES;"
          mysql -h 127.0.0.1 -uci_user -pci_pass -e "SELECT SCHEMA_NAME FROM INFORMATION_SCHEMA.SCHEMATA WHERE SCHEMA_NAME='testdb';"
      - name: Build backend & run unit/integration tests (test profile)
        env:
          SPRING_PROFILES_ACTIVE: test
        run: mvn -q --no-transfer-progress clean verify -Dspring.profiles.active=test
      - name: Install frontend dependencies (for dev server)
        working-directory: frontend
        run: npm ci
      - name: Build frontend (development) for UI tests
        working-directory: frontend
        run: npm run build -- --configuration=development
      - name: Start Angular dev server (background)
        working-directory: frontend
        run: |
          nohup npx ng serve --host 0.0.0.0 --port 4200 --configuration=development > angular.log 2>&1 &
          echo $! > angular.pid
      - name: Start backend application (test profile) against same MySQL
        env:
          SPRING_DATASOURCE_URL: jdbc:mysql://localhost:3306/testdb?useSSL=false&allowPublicKeyRetrieval=true
          SPRING_DATASOURCE_USERNAME: ci_user
          SPRING_DATASOURCE_PASSWORD: ci_pass
          SPRING_JPA_HIBERNATE_DDL_AUTO: update
          SPRING_PROFILES_ACTIVE: test
        run: |
          JAR_FILE=$(find target -name '*.jar' | head -n1)
          [ -z "$JAR_FILE" ] && echo "Backend jar not found" && exit 1
          nohup java -jar "$JAR_FILE" > backend-app.log 2>&1 &
          echo $! > backend.pid
      - name: Wait for backend HTTP 8080
        run: |
          sudo apt-get update && sudo apt-get install -y jq netcat-openbsd || sudo apt-get install -y netcat-traditional
          echo "Waiting for TCP 8080 to open..."
          for i in {1..60}; do
            if nc -z localhost 8080; then echo "Port 8080 open"; break; fi
            echo "Port not open yet ($i)"; sleep 2;
          done
          if ! nc -z localhost 8080; then echo "Port 8080 never opened"; tail -n 200 backend-app.log || true; exit 1; fi
          echo "Polling /api/health and fallback /api/users/login to confirm readiness..."
          READY=0
          for i in {1..40}; do
            RESP=$(curl -s -m 5 http://localhost:8080/api/health || true)
            CODE=$(curl -s -o /dev/null -w '%{http_code}' http://localhost:8080/api/health || true)
            echo "Health attempt $i: HTTP $CODE => $RESP"
            if [ "$CODE" = "200" ]; then
              echo "$RESP" | grep -q '"UP"' && { echo "Health endpoint reports UP"; READY=1; break; }
              echo "$RESP" | grep -q 'status' && { echo "Health JSON has status field"; READY=1; break; }
            fi
            # Fallback: try a lightweight login probe expecting JSON message
            LOGIN_RESP=$(curl -s -m 5 -X POST "http://localhost:8080/api/users/login?email=nouser@example.com&password=test" || true)
            LOGIN_CODE=$(curl -s -o /dev/null -w '%{http_code}' -X POST "http://localhost:8080/api/users/login?email=nouser@example.com&password=test" || true)
            echo "Login probe $i: HTTP $LOGIN_CODE => $LOGIN_RESP"
            if [ "$LOGIN_CODE" = "200" ]; then
              echo "Backend responds to login endpoint; considering ready."; READY=1; break;
            fi
            sleep 3
          done
          if [ $READY -ne 1 ]; then echo "Backend readiness check failed"; tail -n 400 backend-app.log || true; exit 1; fi
      - name: Verify seed data (requests >= 26)
        run: |
          COUNT=$(curl -s http://localhost:8080/api/requests/all | jq 'length') || COUNT=0
          echo "Seeded requests count: $COUNT"
          if [ "$COUNT" -lt 26 ]; then echo "Insufficient seeded requests (<26)."; exit 1; fi
      - name: Wait for Angular dev server 4200
        run: |
          for i in {1..40}; do
            if curl -s http://localhost:4200/ >/dev/null 2>&1; then echo "Frontend up"; exit 0; fi
            echo "Waiting frontend dev server... ($i)"; sleep 3;
          done
          echo "Frontend dev server did not start"; tail -n 200 frontend/angular.log || true; exit 1
      - name: Install Chrome for Selenium tests
        run: |
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable || sudo apt-get install -y chromium-browser
      - name: Run UI Selenium/Cucumber tests (reuse MySQL) headless
        working-directory: testscripts
        run: mvn -q --no-transfer-progress test -Dsurefire.printSummary=true -DbaseUrl=http://localhost:4200 -Dheadless=true
      - name: Upload backend jar artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: backend-jar
          path: "MediBuddy Backend/target/*.jar"
      - name: Upload backend test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-test-reports
          path: "MediBuddy Backend/target/surefire-reports/**"
      - name: Upload UI test reports (Cucumber)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cucumber-reports
          path: testscripts/target/cucumber-reports/**
      - name: Upload UI test reports (TestNG)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: testng-reports
          path: testscripts/target/surefire-reports/**
      - name: Upload runtime logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: runtime-logs
          path: |
            "MediBuddy Backend/backend-app.log"
            frontend/angular.log
      - name: Stop background processes
        if: always()
        run: |
          [ -f angular.pid ] && kill $(cat angular.pid) || true
          [ -f backend.pid ] && kill $(cat backend.pid) || true

  summary:
    runs-on: ubuntu-latest
    needs: [frontend, backend]
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: List artifact contents
        run: |
          echo "Artifacts downloaded:";
          find artifacts -maxdepth 3 -type f | sed 's/^/ - /';
      - name: Summary report
        run: |
          echo "Frontend job status: ${{ needs.frontend.result }}";
          echo "Backend job status: ${{ needs.backend.result }}";
          if [ "${{ needs.frontend.result }}" = "success" ] && [ "${{ needs.backend.result }}" = "success" ]; then echo "All jobs succeeded."; else echo "Some jobs failed."; fi